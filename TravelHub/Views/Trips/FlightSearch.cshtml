@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
    var fromAirportCode = ViewData["FromAirportCode"];
    var toAirportCode = ViewData["ToAirportCode"];
}

<form id="flightForm">
    From
    <div class="autocomplete-container">
        <input type="text" id="from" name="from" placeholder="Enter airport..." autocomplete="off" />
        <div id="autocompleteResultsFrom" class="autocomplete-results"></div>
    </div>

    To:
    <div class="autocomplete-container">
        <input type="text" id="to" name="to" placeholder="Enter airport..." autocomplete="off" />
        <div id="autocompleteResultsTo" class="autocomplete-results"></div>
    </div>

    <fieldset style="margin-top:1em;">
        <legend>Travelers</legend>
        <label>
            Adults:
            <input type="number" id="adults" name="adults" value="1" min="0" max="9" />
        </label>
        <label>
            Children:
            <input type="number" id="children" name="children" value="0" min="0" max="9" />
        </label>
        <label>
            Seated infants:
            <input type="number" id="seatedInfants" name="seatedInfants" value="0" max="9" />
        </label>
        <label>
            Held infants:
            <input type="number" id="heldInfants" name="heldInfants" value="0" max="9" />
        </label>
    </fieldset>


    Date:
    <input type="date" name="date" />

    <input type="submit" value="Submit" />
</form>

<div id="flights">

</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script src="~/lib/luxon/luxon.js"></script>

    <script>

        const defaultToAirportCode = "@Html.Raw(toAirportCode)";
        const defaultFromAirportCode = "@Html.Raw(fromAirportCode)";
        if (defaultToAirportCode.length > 0){
            document.getElementById("to").value = defaultToAirportCode;
        }
         if (defaultFromAirportCode.length > 0){
            document.getElementById("from").value = defaultFromAirportCode;
        }

        document.getElementById("flightForm").addEventListener("submit", function (event) {
          event.preventDefault(); 

          const form = event.target;
          const from = form.from.value;
          const to = form.to.value;
          const date = form.date.value;
          const adults = parseInt(form.adults.value || "0");
          const children = parseInt(form.children.value || "0");
          const seatedInfants = parseInt(form.seatedInfants.value || "0");
          const heldInfants = parseInt(form.heldInfants.value || "0");


          if (new Date(date) < new Date()) {
              alert("Date cannot be in the past.");
              return;
          }

          if (adults < 1) {
              alert("There must be at least one adult traveler.");
              return;
          }

          if ((seatedInfants + heldInfants) > adults) {
              alert("Each infant must be accompanied by an adult.");
              return;
          }

          if ((adults + children) > 9) {
              alert("There may be at most 9 adults and children in total.");
              return;
          }

          handleFlightSearch({ from, to, date, adults, children, seatedInfants, heldInfants });


        });

        function make_get_request(endpoint, on_success){
            fetch(endpoint, {
                method: "GET",
            })
            .then( response => response.json())
            .then(data => {
                on_success(data)
            })
            .catch(error => console.error('Error:', error));
        }

        function handleFlightSearch({ from, to, date, adults, children, seatedInfants, heldInfants }) {
            const params = new URLSearchParams();
            params.append("from", from);
            params.append("to", to);
            params.append("date", date);
            params.append("adults", adults);
            params.append("children", children);
            params.append("seatedInfants", seatedInfants);
            params.append("heldInfants", heldInfants);

            clearFlightCards();
            //tu można by dać jakiś ekran ładowania?
            make_get_request(`/Trips/Flights?${params}`, processFlightList);
        }


        function clearFlightCards(){
            var listDiv = document.getElementById("flights");
            while(listDiv.children[0]) {
                listDiv.removeChild(listDiv.children[0]);
            }
        }

        function processFlightList(flights){
            let listDiv = document.getElementById('flights')
            if (flights.length == 0) {
                addTextSpan(listDiv, `None found`);
            } else {
                flights.slice(0, Math.min(5, flights.length)).forEach((flight) => {
                    listDiv.appendChild(buildFlightCard(flight));
                    listDiv.appendChild(document.createElement("hr"));
                });
            }
            
        }

        function buildFlightCard(flight){
            let div = document.createElement("div");
            div.classList.add('list-group-item');
            div.classList.add('flight-card');

            addTextSpan(div, `${flight.originAirportCode} ---> ${flight.destinationAirportCode}`);
            addTextSpan(div, `${flight.departureTime}      ${flight.arrivalTime}`);
            addTextSpan(div, `Cost: ${flight.totalPrice} ${flight.currency}`);
            addTextSpan(div, `Duration: ${flight.duration}`);
            alert(JSON.stringify(flight));
            if (flight.segments.length == 1){
                addTextSpan(div, `${flight.segments[0].carrierCode}${flight.segments[0].flightNumber}`);
            } else {
                addTextSpan(div, `Segments: `);
                flight.segments.forEach((segment) => {
                    let segmentDiv = document.createElement("div");
                    addTextSpan(segmentDiv, `${segment.originAirportCode} ---> ${segment.destinationAirportCode}`);
                    addTextSpan(segmentDiv, `${segment.departureTime}      ${segment.arrivalTime}`);
                    addTextSpan(segmentDiv, `Duration: ${segment.duration}`);
                    addTextSpan(div, `${segment.carrierCode}${segment.flightNumber}`);
                    div.appendChild(segmentDiv);
                });
            }

            return div;
        }

        function addTextSpan(div, text){
            let span = document.createElement("span");
            span.innerHTML = text;
            div.appendChild(span);
            div.appendChild(document.createElement("br"))
        }

        async function getAutocompleteResults(query) {
          const params = new URLSearchParams();
          params.append("query", query);
          return await fetch(`/Trips/Airports?${params}`, {
                method: "GET",
            })
            .then( response => response.json())
            .catch(error => console.error('Error:', error));
        }

        const MIN_CHARS = 3;    // minimum characters before searching
        const DEBOUNCE_MS = 300; // delay between keystrokes

        // --- Autocomplete logic ---
        const inputFrom = document.getElementById("from");
        const resultsDivFrom = document.getElementById("autocompleteResultsFrom");

        const inputTo = document.getElementById("to");
        const resultsDivTo = document.getElementById("autocompleteResultsTo");

        let debounceTimer;

        function addAutocompleteFunctionality(input, resultsDiv){
            alert(resultsDiv);
            input.addEventListener("input", () => {
              clearTimeout(debounceTimer);
              const query = input.value.trim();

              if (query.length < MIN_CHARS) {
                resultsDiv.innerHTML = ""; // clear results if too short
                return;
              }

              debounceTimer = setTimeout(async () => {
                const results = await getAutocompleteResults(query);
                showResults(results, resultsDiv, input);
              }, DEBOUNCE_MS);
            });

            // Hide results if clicking outside
            document.addEventListener("click", (e) => {
              if (!e.target.closest(".autocomplete-container")) {
                resultsDiv.innerHTML = "";
              }
            });
        }

        addAutocompleteFunctionality(inputFrom, resultsDivFrom);
        addAutocompleteFunctionality(inputTo, resultsDivTo);

        function showResults(results, resultsDiv, input) {
          resultsDiv.innerHTML = "";

          if (results.length === 0) {
            resultsDiv.innerHTML = "<div class='autocomplete-item'>No results</div>";
            return;
          }

          for (const airport of results) {
            const div = document.createElement("div");
            div.classList.add("autocomplete-item");
            div.textContent = `${airport.airportName} (${airport.airportCode})`;

            div.addEventListener("click", () => {
              input.value = airport.airportCode;   // fill text field with code
              resultsDiv.innerHTML = "";    // clear dropdown
            });

            resultsDiv.appendChild(div);
          }
        }

        
    </script>
}

<style>
    .autocomplete-container {
        position: relative;
        width: 300px;
    }

    .autocomplete-results {
        position: absolute;
        background: white;
        border: 1px solid #ccc;
        border-top: none;
        width: 100%;
        max-height: 200px;
        overflow-y: auto;
        z-index: 10;
    }

    .autocomplete-item {
        padding: 8px;
        cursor: pointer;
    }

    .autocomplete-item:hover {
        background: #f0f0f0;
    }
</style>