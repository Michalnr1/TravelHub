@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
    var lat = ViewData["Latitude"];
    var lng = ViewData["Longitude"];
}

<form id="recsForm">
    Latitude
    <input type="text" id="latInput" />

    Longitude
    <input type="text" id="lngInput" />

    Radius (meters)
    <input type="text" id="radiusInput" value="5000" />

    <input type="submit" value="Submit" />
</form>

<div id="list"></div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script src="~/lib/luxon/luxon.js"></script>

    <script>
        const defLat = "@Html.Raw(lat)";
        const defLng = "@Html.Raw(lng)";
        const limit = 1;
        if (defLat.length > 0){
            document.getElementById("latInput").value = defLat;
        }
         if (defLng.length > 0){
            document.getElementById("lngInput").value = defLng;
        }

        document.getElementById("recsForm").addEventListener("submit", function (event) {
          event.preventDefault();

          const form = event.target;
          const lat = form.latInput.value;
          const lng = form.lngInput.value;
          const radius = form.radiusInput.value;

          //jakaś validacja by się przydała
        
          handleRecsSearch({ lat, lng, radius });

        });

        function make_get_request(endpoint, on_success){
            fetch(endpoint, {
                method: "GET",
            })
            .then( response => response.json())
            .then(data => {
                on_success(data)
            })
            .catch(error => console.error('Error:', error));
        }

        function handleRecsSearch({ lat, lng, radius }) {
            const params = new URLSearchParams();
            params.append("lat", lat);
            params.append("lng", lng);
            params.append("radius", radius);

            //tu można by dać jakiś ekran ładowania?
            make_get_request(`/Trips/Recs?${params}`, displayAttractions);
        }

        async function getPhotoUrl(photoName) {
            const params = new URLSearchParams();
            params.append("name", photoName);

            try {
                const response = await fetch(`/Trips/PlacePhoto?${params}`);
                if (!response.ok) {
                    console.warn("Failed to fetch photo URL for", photoName);
                    return null;
                }
                const url = await response.text();
                return url.trim();
            } catch (err) {
                console.error("Error fetching photo URL:", err);
                return null;
            }
        }


        async function displayAttractions(attractions) {
            const containerDiv = document.getElementById("list");
            containerDiv.innerHTML = "";

            if (!attractions || attractions.length === 0) {
                const emptyMsg = document.createElement("p");
                emptyMsg.textContent = "No attractions found.";
                containerDiv.appendChild(emptyMsg);
                return;
            }

            // Process each attraction
            for (const attraction of attractions.slice(0, limit)) {
                const itemDiv = document.createElement("div");
                itemDiv.classList.add("attraction-item");

                const content = `
                    <strong>${attraction.name}</strong><br>
                    Latitude: ${attraction.latitude}<br>
                    Longitude: ${attraction.longitude}<br>
                    Photo Author: ${attraction.photoAuthor ?? "(none)"}<br>
                `;
                itemDiv.innerHTML = content;

                if (attraction.photoName) {
                    const photoUrl = await getPhotoUrl(attraction.photoName);
                    if (photoUrl) {
                        const img = document.createElement("img");
                        img.src = photoUrl;
                        img.alt = attraction.name;
                        img.style.maxWidth = "300px";
                        img.style.display = "block";
                        img.style.marginTop = "8px";
                        itemDiv.appendChild(img);
                    }
                }

                const hr = document.createElement("hr");
                itemDiv.appendChild(hr);

                containerDiv.appendChild(itemDiv);
            }
        }
    </script>

}