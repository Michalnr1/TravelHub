@model TravelHub.Web.ViewModels.Blog.EditCommentViewModel

@{
    ViewData["Title"] = "Edit Comment";
}

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title mb-0">Edit Comment</h4>
                    <small class="text-muted">for post: @Model.PostTitle</small>
                </div>
                <div class="card-body">
                    <form asp-action="EditComment" asp-route-id="@Model.Id" method="post" enctype="multipart/form-data">
                        @Html.AntiForgeryToken()

                        <div class="mb-3">
                            <label asp-for="Content" class="form-label">Content *</label>
                            <div id="editor" style="height: 300px;"></div>
                            <textarea asp-for="Content" id="Content" class="form-control d-none"></textarea>
                            <span asp-validation-for="Content" class="text-danger"></span>
                        </div>

                        <!-- Existing Photos -->
                        @if (Model.ExistingPhotos.Any())
                        {
                            <div class="mb-3">
                                <label class="form-label">Current Photos</label>
                                <div class="row">
                                    @foreach (var photo in Model.ExistingPhotos)
                                    {
                                        <div class="col-md-3 mb-2">
                                            <div class="card">
                                                <img src="@photo.FilePath" class="card-img-top" alt="@photo.Alt" style="height: 100px; object-fit: cover;">
                                                <div class="card-body p-2">
                                                    <button type="button"
                                                            class="btn btn-danger btn-sm w-100"
                                                            onclick="deleteCommentPhoto(@photo.Id, @Model.Id)">
                                                        <i class="fas fa-trash"></i> Delete
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                        }

                        <!-- New Photos -->
                        <div class="mb-3">
                            <label asp-for="NewPhotos" class="form-label">Add New Photos (Optional)</label>
                            <input asp-for="NewPhotos" class="form-control" type="file" multiple accept="image/*" />
                            <div class="form-text">You can add up to 5 new photos. Supported formats: JPG, PNG, WebP. Max 5MB each.</div>
                        </div>

                        <!-- Photo Preview -->
                        <div id="photoPreview" class="row mb-3" style="display: none;"></div>

                        <div class="d-flex justify-content-between">
                            <a href="@Url.Action("Post", "Blog", new { id = Model.PostId })" class="btn btn-secondary">Cancel</a>
                            <button type="submit" class="btn btn-primary">Update Comment</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        var quill = new Quill('#editor', {
            theme: 'snow',
            modules: {
                toolbar: [
                    ['bold', 'italic', 'underline', 'strike'],
                    ['blockquote', 'code-block'],
                    [{ 'header': 1 }, { 'header': 2 }],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    [{ 'script': 'sub'}, { 'script': 'super' }],
                    [{ 'indent': '-1'}, { 'indent': '+1' }],
                    [{ 'direction': 'rtl' }],
                    [{ 'size': ['small', false, 'large', 'huge'] }],
                    [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                    [{ 'color': [] }, { 'background': [] }],
                    [{ 'font': [] }],
                    [{ 'align': [] }],
                    ['link'],
                    ['clean']
                ]
            },
            placeholder: 'Write your comment...',
            theme: 'snow'
        });

        // Synchronizacja z textarea
        quill.on('text-change', function() {
            document.getElementById('Content').value = quill.root.innerHTML;
        });

        // Ustawienie początkowej wartości
        var initialContent = document.getElementById('Content').value;
        if (initialContent) {
            quill.root.innerHTML = initialContent;
        }

        // Photo preview functionality
        document.getElementById('NewPhotos').addEventListener('change', function(e) {
            const preview = document.getElementById('photoPreview');
            preview.innerHTML = '';
            preview.style.display = 'none';

            const files = e.target.files;
            if (files.length > 0) {
                preview.style.display = 'flex';
                preview.classList.add('row', 'g-2');

                for (let i = 0; i < Math.min(files.length, 5); i++) {
                    const file = files[i];
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const col = document.createElement('div');
                            col.className = 'col-6 col-md-4 col-lg-3';
                            col.innerHTML = `
                                <div class="card">
                                    <img src="${e.target.result}" class="card-img-top"
                                         style="height: 100px; object-fit: cover;" alt="Preview">
                                    <div class="card-body p-2">
                                        <small class="text-muted d-block text-truncate">${file.name}</small>
                                        <small class="text-muted">${(file.size / 1024 / 1024).toFixed(2)} MB</small>
                                    </div>
                                </div>
                            `;
                            preview.appendChild(col);
                        };
                        reader.readAsDataURL(file);
                    }
                }
            }
        });

        // Form validation
        document.querySelector('form').addEventListener('submit', function(e) {
            const content = this.querySelector('textarea[name="Content"]');
            if (!content.value.trim()) {
                e.preventDefault();
                content.focus();
                alert('Please enter your comment text.');
            }

            // Check number of photos
            const photoInput = document.getElementById('NewPhotos');
            if (photoInput.files.length > 5) {
                e.preventDefault();
                alert('You can add maximum 5 new photos.');
                return;
            }
        });

        function deleteCommentPhoto(photoId, commentId) {
            if (!confirm("Are you sure you want to delete this photo?")) return;

            const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

            const form = new FormData();
            form.append("photoId", photoId);
            form.append("commentId", commentId);
            form.append("__RequestVerificationToken", token);

            fetch('/Blog/DeleteCommentPhoto', {
                method: 'POST',
                body: form
            })
            .then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    alert('Error deleting photo. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error deleting photo. Please try again.');
            });
        }
    </script>

    <style>
        .card-img-top {
            object-fit: cover;
        }

        .text-truncate {
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        #photoPreview .card {
            transition: transform 0.2s ease-in-out;
        }

            #photoPreview .card:hover {
                transform: scale(1.05);
            }
    </style>
}