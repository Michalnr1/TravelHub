@model TravelHub.Web.ViewModels.Blog.PostViewModel
@{
    ViewData["Title"] = Model.Title;
    var canComment = ViewBag.CanComment ?? true;
    var isScheduledPost = ViewBag.IsScheduledPost ?? false;
}

<div class="container mt-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="@Url.Action("MyTrips", "Trips")">My trips</a></li>
            <li class="breadcrumb-item"><a href="@Url.Action("Index", "Blog", new { tripId = ViewBag.TripId })">Blog</a></li>
            <li class="breadcrumb-item active">@Model.Title</li>
        </ol>
    </nav>

    <!-- Success/Error Messages -->
    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="row">
        <div class="col-lg-8">
            <!-- Post Content -->
            <article class="card shadow-sm mb-4">
                <div class="card-body">
                    <!-- Post Header -->
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <h1 class="card-title h2 mb-0">@Model.Title</h1>
                        @if (Model.AuthorId == User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value)
                        {
                            <div class="dropdown">
                                <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button"
                                        data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li>
                                        <a class="dropdown-item" href="@Url.Action("EditPost", new { id = Model.Id })">
                                            <i class="fas fa-edit me-2"></i>Edit
                                        </a>
                                    </li>
                                    @if (Model.IsScheduled)
                                    {
                                        <li>
                                            <form asp-action="PublishNow" method="post" class="d-inline">
                                                <input type="hidden" name="postId" value="@Model.Id" />
                                                <button type="submit" class="dropdown-item text-info"
                                                        onclick="return confirm('Are you sure you want to publish this post immediately?')">
                                                    <i class="fas fa-paper-plane me-2"></i>Publish Now
                                                </button>
                                            </form>
                                        </li>
                                    }
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <form asp-action="DeletePost" method="post" class="d-inline">
                                            <input type="hidden" name="id" value="@Model.Id" />
                                            <button type="submit" class="dropdown-item text-danger"
                                                    onclick="return confirm('Are you sure you want to delete this post?')">
                                                <i class="fas fa-trash me-2"></i>Delete
                                            </button>
                                        </form>
                                    </li>
                                </ul>
                            </div>
                        }
                    </div>

                    <!-- Post Meta -->
                    <div class="post-meta mb-4">
                        <!-- Status postu -->
                        @if (Model.IsScheduled)
                        {
                            <div class="alert alert-warning alert-dismissible fade show mb-3" role="alert">
                                <i class="fas fa-clock me-2"></i>
                                <strong>Scheduled Post</strong> - This post is scheduled for publication on
                                <strong>@Model.ScheduledFor?.ToString("MM/dd/yyyy HH:mm")</strong>
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        }

                        <div class="d-flex flex-wrap align-items-center text-muted small">
                            <!-- Author -->
                            <div class="me-3">
                                <i class="fas fa-user me-1"></i>
                                @Model.AuthorName
                            </div>

                            <!-- Creation Date -->
                            <div class="me-3">
                                <i class="fas fa-calendar me-1"></i>
                                Created: @Model.CreationDate.ToString("MM/dd/yyyy HH:mm")
                            </div>

                            <!-- Published Date -->
                            @if (Model.PublishedDate.HasValue)
                            {
                                <div class="me-3">
                                    <i class="fas fa-paper-plane me-1"></i>
                                    Published: @Model.PublishedDate.Value.ToString("MM/dd/yyyy HH:mm")
                                </div>
                            }

                            <!-- Scheduled Date -->
                            @if (Model.IsScheduled && Model.ScheduledFor.HasValue)
                            {
                                <div class="me-3">
                                    <i class="fas fa-clock me-1"></i>
                                    Scheduled: @Model.ScheduledFor.Value.ToString("MM/dd/yyyy HH:mm")
                                </div>
                            }

                            <!-- Edit Date -->
                            @if (Model.EditDate.HasValue)
                            {
                                <div class="me-3">
                                    <i class="fas fa-edit me-1"></i>
                                    Edited: @Model.EditDate.Value.ToString("MM/dd/yyyy HH:mm")
                                </div>
                            }

                            <!-- Trip Day -->
                            @if (!string.IsNullOrEmpty(Model.DayName))
                            {
                                <div class="me-3">
                                    <i class="fas fa-calendar-day me-1"></i>
                                    @Model.DayName
                                </div>
                            }

                            <!-- Status Badge -->
                            <div class="me-3">
                                @if (Model.IsScheduled)
                                {
                                    <span class="badge bg-warning text-dark">
                                        <i class="fas fa-clock me-1"></i>Scheduled
                                    </span>
                                }
                                else
                                {
                                    <span class="badge bg-success">
                                        <i class="fas fa-check me-1"></i>Published
                                    </span>
                                }
                            </div>
                        </div>
                    </div>

                    <!-- Post Content -->
                    <div class="post-content mb-4">
                        @Html.Raw(Model.Content)
                    </div>

                    <!-- Post Photos -->
                    @if (Model.Photos.Any())
                    {
                        <div class="post-photos mb-4">
                            <h5 class="mb-3">
                                <i class="fas fa-images me-2"></i>Attached Photos (@Model.Photos.Count)
                            </h5>
                            <div class="row g-3">
                                @foreach (var photo in Model.Photos)
                                {
                                    <div class="col-sm-6 col-lg-4">
                                        <div class="card h-100">
                                            <img src="@photo.FilePath" class="card-img-top photo-thumbnail"
                                                 alt="@photo.Alt" style="height: 200px; object-fit: cover; cursor: pointer;"
                                                 onclick="openImageModal('@photo.FilePath', '@photo.Alt')">
                                            <div class="card-body p-2">
                                                <p class="card-text small text-muted mb-0">@photo.Name</p>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
            </article>

            <!-- Comments Section -->
            <section class="comments-section">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="h4 mb-0">
                        <i class="fas fa-comments me-2"></i>Comments
                        <span class="badge bg-primary ms-2">@Model.Comments.Count</span>
                    </h3>
                </div>

                @if (isScheduledPost)
                {
                    <div class="alert alert-info">
                        <i class="fas fa-comment-slash me-2"></i>
                        <strong>Comments are disabled</strong> - This post is scheduled for publication and cannot be commented on yet.
                        Comments will be enabled after the post is published.
                    </div>
                }
                else
                {
                    <!-- Comments List -->
                    @if (Model.Comments.Any())
                    {
                        <div class="comments-list">
                            @foreach (var comment in Model.Comments)
                            {
                                <div class="card mb-3" id="comment-@comment.Id">
                                    <div class="card-body">
                                        <!-- Comment Header -->
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <div>
                                                <h6 class="card-subtitle mb-1 fw-bold">@comment.AuthorName</h6>
                                                <small class="text-muted">
                                                    <i class="fas fa-clock me-1"></i>
                                                    @comment.CreationDate.ToString("MM/dd/yyyy HH:mm")
                                                    @if (comment.EditDate.HasValue)
                                                    {
                                                        <span class="ms-2">
                                                            <i class="fas fa-edit me-1"></i>
                                                            Edited: @comment.EditDate.Value.ToString("MM/dd/yyyy HH:mm")
                                                        </span>
                                                    }
                                                </small>
                                            </div>
                                            @if (comment.AuthorId == User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value)
                                            {
                                                <div class="dropdown">
                                                    <button class="btn btn-sm btn-outline-secondary border-0 dropdown-toggle"
                                                            type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                                        <i class="fas fa-ellipsis-v"></i>
                                                    </button>
                                                    <ul class="dropdown-menu">
                                                        <li>
                                                            <a class="dropdown-item" href="@Url.Action("EditComment", new { id = comment.Id })">
                                                                <i class="fas fa-edit me-2"></i>Edit
                                                            </a>
                                                        </li>
                                                        <li><hr class="dropdown-divider"></li>
                                                        <li>
                                                            <form asp-action="DeleteComment" method="post" class="d-inline">
                                                                <input type="hidden" name="id" value="@comment.Id" />
                                                                <button type="submit" class="dropdown-item text-danger"
                                                                        onclick="return confirm('Are you sure you want to delete this comment?')">
                                                                    <i class="fas fa-trash me-2"></i>Delete
                                                                </button>
                                                            </form>
                                                        </li>
                                                    </ul>
                                                </div>
                                            }
                                        </div>

                                        <!-- Comment Content -->
                                        <div class="card-text comment-content">@Html.Raw(comment.Content)</div>

                                        <!-- Comment Photos -->
                                        @if (comment.Photos.Any())
                                        {
                                            <div class="comment-photos mt-3">
                                                <div class="row g-2">
                                                    @foreach (var photo in comment.Photos)
                                                    {
                                                        <div class="col-4 col-md-3">
                                                            <div class="position-relative">
                                                                <img src="@photo.FilePath" class="img-fluid rounded"
                                                                     alt="@photo.Alt" style="height: 100px; object-fit: cover; cursor: pointer;"
                                                                     onclick="openImageModal('@photo.FilePath', '@photo.Alt')">
                                                                @if (comment.AuthorId == User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value)
                                                                {
                                                                    <button type="button"
                                                                            class="btn btn-sm btn-danger rounded-circle position-absolute top-0 end-0 m-1"
                                                                            style="width: 24px; height: 24px; padding: 0;"
                                                                            onclick="deleteCommentPhoto(@photo.Id, @comment.Id)">
                                                                        <i class="fas fa-times" style="font-size: 0.7rem;"></i>
                                                                    </button>
                                                                }
                                                            </div>
                                                        </div>
                                                    }
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-4">
                            <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No comments yet. Be the first to comment!</p>
                        </div>
                    }

                    <!-- Add Comment Form -->
                    @if (canComment)
                    {
                        <div class="card mt-4">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-plus me-2"></i>Add Comment
                                </h5>
                            </div>
                            <div class="card-body">
                                <form asp-action="CreateComment" method="post" enctype="multipart/form-data" id="commentForm">
                                    <input type="hidden" name="PostId" value="@Model.Id" />

                                    <div class="mb-3">
                                        <label for="CommentContent" class="form-label">Content *</label>
                                        <div id="commentEditor" style="height: 150px;"></div>
                                        <textarea name="Content" id="CommentContent" class="form-control d-none"></textarea>
                                        <span class="text-danger" id="commentContentValidation"></span>
                                    </div>

                                    <div class="mb-3">
                                        <label for="Photos" class="form-label">Photos (optional)</label>
                                        <input type="file" name="Photos" class="form-control" multiple
                                               accept="image/*" id="commentPhotos">
                                        <div class="form-text">You can add up to 5 photos</div>
                                    </div>

                                    <!-- Photo Preview -->
                                    <div id="photoPreview" class="row g-2 mb-3 d-none"></div>

                                    <div class="d-flex justify-content-between align-items-center">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-paper-plane me-2"></i>Add Comment
                                        </button>
                                        <small class="text-muted">* required fields</small>
                                    </div>
                                </form>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            You don't have permission to comment on this post.
                        </div>
                    }
                }
            </section>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <div class="sticky-top" style="top: 20px;">
                <!-- Blog Info -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-info-circle me-2"></i>Information
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <strong>Post Author:</strong><br>
                            @Model.AuthorName
                        </div>
                        <div class="mb-3">
                            <strong>Status:</strong><br>
                            @if (Model.IsScheduled)
                            {
                                <span class="badge bg-warning text-dark">Scheduled</span>
                            }
                            else
                            {
                                <span class="badge bg-success">Published</span>
                            }
                        </div>
                        <div class="mb-3">
                            <strong>Publication Date:</strong><br>
                            @Model.PublishedDate?.ToString("MM/dd/yyyy HH:mm")
                        </div>
                        @if (Model.ScheduledFor.HasValue && Model.IsScheduled)
                        {
                            <div class="mb-3">
                                <strong>Scheduled For:</strong><br>
                                @Model.ScheduledFor.Value.ToString("MM/dd/yyyy HH:mm")
                            </div>
                        }
                        @if (!string.IsNullOrEmpty(Model.DayName))
                        {
                            <div class="mb-3">
                                <strong>Trip Day:</strong><br>
                                @Model.DayName
                            </div>
                        }
                        <div>
                            <strong>Number of Comments:</strong><br>
                            @Model.Comments.Count
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="card shadow-sm">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-bolt me-2"></i>Actions
                        </h5>
                    </div>
                    <div class="card-body">
                        <a href="@Url.Action("Index", "Blog", new { tripId = ViewBag.TripId })"
                           class="btn btn-outline-primary w-100 mb-2">
                            <i class="fas fa-arrow-left me-2"></i>Back to Blog
                        </a>
                        <a href="@Url.Action("CreatePost", "Blog", new { blogId = Model.BlogId })"
                           class="btn btn-success w-100 mb-2">
                            <i class="fas fa-plus me-2"></i>New Post
                        </a>
                        @if (Model.IsScheduled && Model.AuthorId == User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value)
                        {
                            <form asp-action="PublishNow" method="post" class="d-inline w-100">
                                <input type="hidden" name="postId" value="@Model.Id" />
                                <button type="submit" class="btn btn-warning w-100"
                                        onclick="return confirm('Are you sure you want to publish this post immediately?')">
                                    <i class="fas fa-paper-plane me-2"></i>Publish Now
                                </button>
                            </form>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalLabel">Photo Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalImage" src="" alt="" class="img-fluid">
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        .photo-thumbnail {
            transition: transform 0.2s ease-in-out;
        }

            .photo-thumbnail:hover {
                transform: scale(1.05);
            }

        .comments-section .card {
            border-left: 4px solid #0d6efd;
        }

        .sticky-top {
            z-index: 1;
        }

        .dropdown-toggle::after {
            display: none;
        }

        .post-content img {
            max-width: 100%;
            height: auto;
        }

        .comment-content img {
            max-width: 100%;
            height: auto;
        }
    </style>

    @if (ViewBag.IsPublicView ?? false)
    {
        <style>
            .dropdown-menu, .btn-group, #commentForm, .btn-danger {
                display: none !important;
            }
        </style>
    }
}

@section Scripts {
    <script>
        // Quill Editor for Comments
        var commentQuill = new Quill('#commentEditor', {
            theme: 'snow',
            modules: {
                toolbar: [
                    ['bold', 'italic', 'underline', 'strike'],
                    ['blockquote', 'code-block'],
                    [{ 'header': 1 }, { 'header': 2 }],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    [{ 'script': 'sub'}, { 'script': 'super' }],
                    [{ 'indent': '-1'}, { 'indent': '+1' }],
                    [{ 'direction': 'rtl' }],
                    [{ 'size': ['small', false, 'large', 'huge'] }],
                    [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                    [{ 'color': [] }, { 'background': [] }],
                    [{ 'font': [] }],
                    [{ 'align': [] }],
                    ['link', 'image'],
                    ['clean']
                ]
            },
            placeholder: 'Write your comment...',
            theme: 'snow'
        });

        // Synchronizacja edytora komentarza z textarea
        commentQuill.on('text-change', function() {
            document.getElementById('CommentContent').value = commentQuill.root.innerHTML;
        });

        // Ustawienie pustej początkowej wartości dla komentarza
        document.getElementById('CommentContent').value = '';

        // Photo preview for comment form
        document.getElementById('commentPhotos').addEventListener('change', function(e) {
            const preview = document.getElementById('photoPreview');
            preview.innerHTML = '';
            preview.classList.add('d-none');

            const files = e.target.files;
            if (files.length > 0) {
                preview.classList.remove('d-none');

                for (let i = 0; i < Math.min(files.length, 5); i++) {
                    const file = files[i];
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const col = document.createElement('div');
                            col.className = 'col-6 col-md-4';
                            col.innerHTML = `
                                <div class="card">
                                    <img src="${e.target.result}" class="card-img-top"
                                         style="height: 100px; object-fit: cover;" alt="Preview">
                                    <div class="card-body p-2">
                                        <small class="text-muted">${file.name}</small>
                                    </div>
                                </div>
                            `;
                            preview.appendChild(col);
                        };
                        reader.readAsDataURL(file);
                    }
                }
            }
        });

        // Form validation
        document.getElementById('commentForm')?.addEventListener('submit', function(e) {
            const content = this.querySelector('textarea[name="Content"]');
            if (!content.value.trim()) {
                e.preventDefault();
                content.focus();
                alert('Please enter your comment text');
            }
        });

        // Delete comment photo function
        function deleteCommentPhoto(photoId, commentId) {
            if (!confirm("Are you sure you want to delete this photo?")) return;

            const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

            const form = new FormData();
            form.append("photoId", photoId);
            form.append("commentId", commentId);
            form.append("__RequestVerificationToken", token);

            fetch('/Blog/DeleteCommentPhoto', {
                method: 'POST',
                body: form
            })
            .then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    alert('Error deleting photo. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error deleting photo. Please try again.');
            });
        }

        // Image modal function
        function openImageModal(src, alt) {
            const modalImage = document.getElementById('modalImage');
            modalImage.src = src;
            modalImage.alt = alt;
            const imageModal = new bootstrap.Modal(document.getElementById('imageModal'));
            imageModal.show();
        }

        // Smooth scroll to comment after form submission
        @if (TempData["Success"] != null)
        {
                <text>
                setTimeout(function() {
                    const commentsSection = document.querySelector('.comments-section');
                    if (commentsSection) {
                        commentsSection.scrollIntoView({ behavior: 'smooth' });
                    }
                }, 100);
                </text>
        }
    </script>
}