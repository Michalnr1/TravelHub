@model TravelHub.Web.ViewModels.Blog.CreatePostViewModel
@{
    ViewData["Title"] = "Edit Post";
    var photos = ViewBag.Photos as List<TravelHub.Web.ViewModels.Blog.PhotoViewModel> ?? new List<TravelHub.Web.ViewModels.Blog.PhotoViewModel>();
}

<div class="container">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <h1>Edit Post</h1>

            <form asp-action="EditPost" asp-route-id="@ViewBag.PostId" method="post" enctype="multipart/form-data">
                @Html.AntiForgeryToken()

                <div class="mb-3">
                    <label asp-for="Title" class="form-label">Title *</label>
                    <input asp-for="Title" class="form-control" />
                    <span asp-validation-for="Title" class="text-danger"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="Content" class="form-label">Content *</label>
                    <textarea asp-for="Content" class="form-control" rows="10"></textarea>
                    <span asp-validation-for="Content" class="text-danger"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="DayId" class="form-label">Trip Day (optional)</label>
                    <select asp-for="DayId" class="form-control">
                        <option value="">-- Select Day --</option>
                        @foreach (var day in Model.Days.OrderBy(d => d.Number))
                        {
                            <option value="@day.Id" selected="@(day.Id == Model.DayId)">
                                @if (string.IsNullOrEmpty(day.Name))
                                {
                                    <text>Day @day.Number</text>
                                }
                                else
                                {
                                    <text>@day.Name (Day @day.Number)</text>
                                }
                            </option>
                        }
                    </select>
                </div>

                <!-- Existing Photos -->
                @if (photos.Any())
                {
                    <div class="mb-3">
                        <label class="form-label">Current Photos</label>
                        <div class="row">
                            @foreach (var photo in photos)
                            {
                                <div class="col-md-3 mb-2">
                                    <div class="card">
                                        <img src="@photo.FilePath" class="card-img-top" alt="@photo.Alt" style="height: 150px; object-fit: cover;">
                                        <div class="card-body p-2">
                                            <button type="button"
                                                    class="btn btn-danger btn-sm w-100"
                                                    onclick="deletePhoto(@photo.Id, @ViewBag.PostId)">
                                                Delete
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                }

                <div class="mb-3">
                    <label asp-for="Photos" class="form-label">Add New Photos (optional)</label>
                    <input asp-for="Photos" class="form-control" type="file" multiple accept="image/*" />
                    <div class="form-text">You can add up to 10 new photos.</div>
                </div>

                <!-- Photo Preview -->
                <div id="photoPreview" class="row mb-3" style="display: none;"></div>

                <div class="mb-3">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Save Changes
                    </button>
                    <a href="@Url.Action("Post", "Blog", new { id = ViewBag.PostId })" class="btn btn-secondary">
                        <i class="fas fa-times me-2"></i>Cancel
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        // Set selected option for dropdown
        document.addEventListener('DOMContentLoaded', function() {
            const dayId = @(Model.DayId.HasValue? Model.DayId.Value : 0);
            if (dayId > 0) {
                const select = document.querySelector('select[name="DayId"]');
                if (select) {
                    select.value = dayId;
                }
            }
        });

        // Photo preview functionality
        document.getElementById('Photos').addEventListener('change', function(e) {
            const preview = document.getElementById('photoPreview');
            preview.innerHTML = '';
            preview.style.display = 'none';

            const files = e.target.files;
            if (files.length > 0) {
                preview.style.display = 'flex';
                preview.classList.add('row', 'g-2');

                for (let i = 0; i < Math.min(files.length, 10); i++) {
                    const file = files[i];
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const col = document.createElement('div');
                            col.className = 'col-6 col-md-4 col-lg-3';
                            col.innerHTML = `
                                <div class="card">
                                    <img src="${e.target.result}" class="card-img-top"
                                         style="height: 120px; object-fit: cover;" alt="Preview">
                                    <div class="card-body p-2">
                                        <small class="text-muted d-block text-truncate">${file.name}</small>
                                        <small class="text-muted">${(file.size / 1024 / 1024).toFixed(2)} MB</small>
                                    </div>
                                </div>
                            `;
                            preview.appendChild(col);
                        };
                        reader.readAsDataURL(file);
                    }
                }
            }
        });

        function deletePhoto(photoId, postId) {
            if (!confirm("Are you sure you want to delete this photo?")) return;

            const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

            const form = new FormData();
            form.append("photoId", photoId);
            form.append("postId", postId);
            form.append("__RequestVerificationToken", token);

            fetch('/Blog/DeletePostPhoto', {
                method: 'POST',
                body: form
            })
            .then(() => location.reload());
        }
    </script>
}