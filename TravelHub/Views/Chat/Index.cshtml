@model TravelHub.Web.ViewModels.Trips.ChatViewModel

<h3>Chat</h3>

<div class="mb-3">
    <!-- Back to Trip details -->
    <a asp-controller="Trips"
       asp-action="Details"
       asp-route-id="@Model.TripId"
       class="btn btn-secondary">
        Back to Trip
    </a>
</div>

<div id="chatMessages">
    @await Html.PartialAsync("_ChatMessagesPartial", Model.Messages)
</div>

<hr />

@* message form *@
<form id="chatForm" asp-action="PostMessage" asp-controller="Chat" method="post">
    <input type="hidden" name="tripId" value="@Model.TripId" />
    <div class="mb-3">
        <label class="form-label">Message</label>
        <div id="chatEditor" style="height: 150px;"></div>
        <textarea name="Message" id="chatMessageText" class="form-control d-none"></textarea>
        <span class="text-danger" id="messageValidation"></span>
    </div>
    <button type="submit" class="btn btn-primary">Send</button>
</form>

@section Scripts {
    <script>
        var chatQuill = new Quill('#chatEditor', {
            theme: 'snow',
            modules: {
                toolbar: [
                    ['bold', 'italic', 'underline', 'strike'],
                    ['blockquote', 'code-block'],
                    [{ 'header': 1 }, { 'header': 2 }],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    [{ 'script': 'sub'}, { 'script': 'super' }],
                    [{ 'indent': '-1'}, { 'indent': '+1' }],
                    [{ 'direction': 'rtl' }],
                    [{ 'size': ['small', false, 'large', 'huge'] }],
                    [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                    [{ 'color': [] }, { 'background': [] }],
                    [{ 'font': [] }],
                    [{ 'align': [] }],
                    ['link'],
                    ['clean']
                ]
            },
            placeholder: 'Write your message...',
            theme: 'snow'
        });

        // Synchronizacja edytora komentarza z textarea
        chatQuill.on('text-change', function() {
            document.getElementById('chatMessageText').value = chatQuill.root.innerHTML;
        });

        // Ustawienie pustej początkowej wartości dla komentarza
        document.getElementById('chatMessageText').value = '';

        const chatForm = document.getElementById('chatForm');
        chatForm.addEventListener('submit', async function (e) {
            e.preventDefault();

            const messageText = document.getElementById('chatMessageText').value;
            const validationSpan = document.getElementById('messageValidation');

            // Reset validation
            validationSpan.textContent = '';

            // Walidacja
            if (!messageText.trim() || chatQuill.getText().trim().length === 0) {
                e.preventDefault();
                validationSpan.textContent = 'Please enter your message';
                chatQuill.focus();
                return;
            }

            const formData = new FormData(chatForm);

            const response = await fetch(chatForm.action + '?tripId=' + formData.get('tripId'), {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            if (response.redirected) {
                window.location.href = response.url;
                return;
            }

            const partialRes = await fetch('@Url.Action("MessagesPartial", "Chat")?tripId=' + formData.get('tripId'));
            const html = await partialRes.text();
            document.getElementById('chatMessages').innerHTML = html;

            // Wyczyść edytor
            chatQuill.root.innerHTML = '';
            document.getElementById('chatMessageText').value = '';
        });

        // polling every 5s, without site refresh
        setInterval(async () => {
            const tripId = '@Model.TripId';
            const partialRes = await fetch('@Url.Action("MessagesPartial", "Chat")?tripId=' + tripId);
            const html = await partialRes.text();
            document.getElementById('chatMessages').innerHTML = html;
        }, 5000);
    </script>
}
